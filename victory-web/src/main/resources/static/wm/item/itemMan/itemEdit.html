<div class="loadedContent" id="itemEdit">
    <div class="panel panel-primary">
        <div class="panel-heading">
            <span class="panel-header-ele"><b>发布/编辑商品</b></span>
        </div>
        <div class="panel-body">
            <form class="form-default am-hide" id="itemEditQForm">
                <div class="row">
                    <div class="col-lg-4 col-md-4 col-sm-4">
                        <div class="input-group input-group-sm">
                            <span class="input-group-addon">商品ID</span>
                            <input type="text" name="id" class="form-control"/>
                        </div>
                    </div>
                    <button id="query" type="submit" class="commonSubmit btn btn-primary btn-sm am-animation-fade">
                        <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                        查询
                    </button>
                </div>
            </form>

            <form class="form-default" id="itemEditForm" enctype="multipart/form-data" data-am-validator>
                <div class="small">
                    <div class="panel panel-default panel-cate">
                        <div class="panel-heading">
                            类目信息
                        </div>
                        <div class="panel-body am-text-center">
                            <div class="row">
                                <div class="col-lg-7 col-md-7 col-sm-7">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">类目</span>
                                        <select class="form-control data-am-selected cate-select" name="cateId">
                                        </select>
                                        <b style="color:red;font-size:.5rem;margin-left:3rem;">(注意：必须选择三级类目，即叶子类目)</b>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default panel-item">
                        <div class="panel-heading">
                            商品信息
                        </div>
                        <div class="panel-body am-text-center">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">商品ID</span>
                                        <input type="text" name="id" class="form-control" disabled/>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">商品编码</span>
                                        <input type="text" name="outerNo" class="form-control" placeholder="其他系统的商品ID，如ERP"/>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon"><i class="required-star">*</i>标题</span>
                                        <input type="text" name="title" class="form-control" placeholder="字符数大于10,小于20" minlength="10" maxlength="20" required/>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">副标题</span>
                                        <input type="text" name="subTitle" class="form-control" placeholder="字符数小于10" maxlength="10"/>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">关键词</span>
                                        <input type="text" name="key" class="form-control" placeholder="字符数小于10，空格分割" maxlength="10"/>
                                    </div>
                                </div>
                            </div>
                            <hr data-am-widget="divider" style="" class="am-divider am-divider-dotted" />
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon"><i class="required-star">*</i>成本</span>
                                        <input type="number" name="cost" class="form-control" pattern="^(\d+|\d+\.\d{1,2})$" placeholder="整数或两位小数，不小于0.01" min="0.01" required/>
                                        <span class="input-group-addon">元</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon"><i class="required-star">*</i>标价</span>
                                        <input type="number" name="labelPrice" class="form-control" pattern="^(\d+|\d+\.\d{1,2})$" placeholder="整数或两位小数，不小于0", min="0" required/>
                                        <span class="input-group-addon">元</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon"><i class="required-star">*</i>一口价</span>
                                        <input type="number" name="price" class="form-control" pattern="^(\d+|\d+\.\d{1,2})$" placeholder="整数或两位小数，不小于0", min="0" required/>
                                        <span class="input-group-addon">元</span>
                                    </div>
                                </div>
                            </div>
                            <hr data-am-widget="divider" style="" class="am-divider am-divider-dotted" />
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">库存</span>
                                        <input type="number" name="inventory" class="form-control" pattern="^(\d+)$" placeholder="不小于0", min="0"/>
                                        <span class="input-group-addon">件</span>
                                    </div>
                                    <div>
                                        <span style="color: red;">若存在sku，则以sku总库存为准。</span>
                                    </div>
                                </div>
                                <!--<div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">起卖数</span>
                                        <input type="number" name="minimum" class="form-control" pattern="^(\d+)$" placeholder="整数，不小于0", min="0"/>
                                        <span class="input-group-addon">件</span>
                                    </div>
                                </div>-->
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">总销量</span>
                                        <input type="number" name="sales" class="form-control" pattern="^(\d+)$" placeholder="整数，不小于0", min="0"/>
                                        <span class="input-group-addon">件</span>
                                    </div>
                                    <div>
                                        <span style="color: red;">每售出一件，在该销量基础上加一。</span>
                                    </div>
                                </div>
                            </div>
                            <hr data-am-widget="divider" style="" class="am-divider am-divider-dotted" />
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">重量</span>
                                        <input type="number" name="attr.weight" class="form-control" pattern="^(\d+|\d+\.\d{1,2})$" placeholder="整数或两位小数，不小于0", min="0"/>
                                        <span class="input-group-addon">千克</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">体积</span>
                                        <input type="number" name="attr.volume" class="form-control" pattern="^(\d+|\d+\.\d{1,2})$" placeholder="整数或两位小数，不小于0", min="0"/>
                                        <span class="input-group-addon">立方米</span>
                                    </div>
                                </div>
                            </div>
                            <!--<hr data-am-widget="divider" style="" class="am-divider am-divider-dotted" />
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">预售</span>
                                        <select name="presell" class="form-control">
                                            <option value="1">是</option>
                                            <option value="0">否</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4 col-sm-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon">发货日期</span>
                                        <input type="text" class="datetime date-start input-sm form-control" name="startSent" data-format="yyyy-mm-dd "/>
                                        <span class="add-on"><i class="icon-remove"></i></span>
                                    </div>
                                    <div>
                                        <span style="color: red;">预售商品，必须填写发货日期。</span>
                                    </div>
                                </div>
                            </div>
-->

                            <hr data-am-widget="divider" style="" class="am-divider am-divider-dotted" />
                            <div class="row">
                                <div class="col-lg-1 col-md-1 col-sm-1">
                                    <div class="input-group input-group-sm"  style="height: 60px;">
                                        <span class="input-group-addon">图片</span>
                                        <!--<input type="hidden" name="imgs" class="form-control" disabled/>-->
                                        <span class="input-group-addon"></span>
                                    </div>
                                </div>
                                <div class="col-lg-11 col-md-11 col-sm-11">
                                    <div class="input-group input-group-sm float-left uploaded-imgs">
                                        <input type="hidden" name='imgs' class="form-control">
                                    </div>
                                    <div class="input-group input-group-sm am-form-file">
                                        <div>
                                            <button type="button" class="am-btn am-btn-secondary am-btn-sm item-img-upload">
                                                <i class="am-icon-plus am-icon-lg"></i>
                                            </button>
                                            <input id="fileupload" type="file" name="imgFile" multiple  class="item-img-upload">
                                            <span style="color: red;">要求图片大小 不大于 200KB。建议正方形且尺寸355px*355px。建议所有商品的图片尺寸相同，避免商品列表排版错乱。</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default panel-sku">
                        <div class="panel-heading">
                            SKU
                        </div>
                        <div class="panel-body" style="width:70%;margin:auto;">
                            <button type="button" class="btn btn-primary btn-xs add-sku-outer float-right" style="margin-bottom: 5px;">增加</button>
                            <br/>
                            <table class="display table table-bordered table-hover small sku-table" width="100%">
                                <thead>
                                <tr>
                                    <th class='col-lg-5'>sku描述(规格等)</th>
                                    <th class='col-lg-2'>一口价(单位：元)</th>
                                    <th class='col-lg-2'>库存(单位：件)</th>
                                    <th class='col-lg-1'></th>
                                </tr>
                                </thead>
                                <tbody>
                                    <!--<tr>
                                        <td>
                                            <input type="text" name="skuTitle" style="width: 100%"/>
                                        </td>
                                        <td>
                                            <input type="number" name="skuPrice"/>
                                        </td>
                                        <td>
                                            <input type="number" name="skuInventory"/>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-primary btn-xs add-sku">+</button>
                                            <button type="button" class="btn btn-primary btn-xs reduce-sku">-</button>
                                        </td>
                                    </tr>-->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="panel panel-default panel-logistics">
                        <div class="panel-heading">
                            物流
                        </div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label class="col-lg-2 control-label">免物流</label>
                                <div class="col-lg-10 radio">
                                    <label>
                                        <input type="radio" class="form-control my-radio" name="logistics.needLogistics" value="0">自提
                                    </label>
                                    <label>
                                        <input type="radio" class="form-control my-radio" name="logistics.needLogistics" value="1">需要物流
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-lg-2 control-label">运费设置</label>
                                <div class="col-lg-10 radio">
                                    <div>
                                        <label>
                                            <input type="radio" class="form-control my-radio my-radio-checked" name="logistics.freightStrategy" value="0">免运费
                                        </label>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="radio" class="form-control my-radio my-radio-checked" name="logistics.freightStrategy" id="sameFreightRadio" value="1">
                                            统一运费
                                            <input type="number" class="form-control my-radio-val" style="width: 60%;display: inline-block;font-size: .2rem;" name="logistics.sameFreightVal" pattern="^(\d+)$" placeholder="整数，不小于0", min="0">元
                                        </label>
                                    </div>
                                    <!--<div>
                                        <label>
                                            <input type="radio" class="form-control my-radio" name="freightStrategy" value="2">
                                            运费模板
                                            <select class="form-control" name="freightTemp" style="display: inline-block;">
                                                <option value="1">运费模板1</option>
                                                <option value="2">运费模板2</option>
                                            </select>
                                        </label>
                                    </div>-->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--<div class="panel panel-default panel-coupon">
                        <div class="panel-heading">
                            优惠、积分
                        </div>
                        <div class="panel-body">
                            敬请期待
                        </div>
                    </div>
                    <div class="panel panel-default panel-others">
                        <div class="panel-heading">
                            其他
                        </div>
                        <div class="panel-body">
                            敬请期待
                        </div>
                    </div>-->
                    <div class="panel panel-default panel-detail">
                        <div class="panel-heading">
                            详情
                        </div>
                        <div class="panel-body">
                            <div style="display: inline-block;" class="float-left">
                                <script id="item-detail-container" type="text/plain"/>
                            </div>
                            <div style="display: inline-block;margin: 0 50px;"><button class="am-btn am-btn-success sync-phone">查看效果</button></div>
                            <div name="detail" class="my-phone">
                                <div class="my-phone-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" align="center">
                    <button id="save" type="submit" class="commonSubmit btn btn-primary btn-sm am-animation-fade">
                        <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>

    $(function () {

        $('#itemEditForm .datetime').datetimepicker({
            format: "yyyy-mm-dd hh:ii:ss",
            todayBtn: "linked",
            clearBtn: true,
            language: "zh-CN",
            keyboardNavigation: false,
            forceParse: false,
            autoclose:true,
            todayHighlight: true
        })

        /*单选框关联的输入 必填验证*/
        $('#itemEdit .my-radio-checked').bind('click', function () {
            $('#itemEdit .my-radio').not(this).nextAll('.my-radio-val').removeAttr('required').removeClass('am-field-error am-active')
            if (this.checked){
                $(this).nextAll('.my-radio-val').attr('required', true)
            }
        })

        $('#itemEdit .sync-phone').on('click', function () {
            $(this).parent().parent().find('.my-phone-container').html(editor.getContent())
            return false
        })

        /*开启表单验证*/
        $('#itemEdit #itemEditForm').validator({})

        fileUploadUtils.bind({selecter:'#itemEdit #fileupload',url:'/p/wm/img/upload',size:1024*200})

        /*sku*/
        $('#itemEdit').on('click', '.add-sku-outer', function () {
            //$(this).nextAll('table:first').find('tbody').append(newEle)
            addSkuInItemEdit()
            resizeContentHeight()
        })
        $('#itemEdit').on('click', '.sku-table .add-sku', function () {
            //$(this).parents('tbody:first').append(newEle)
            addSkuInItemEdit()
            resizeContentHeight()
        })
        $('#itemEdit').on('click', '.sku-table .reduce-sku', function () {
            $(this).parents('tr:first').remove()
            resizeContentHeight()
        })
        var addSkuInItemEdit = function(sku){
            var id = '',title = '', price = '', inventory = ''
            if (ObjectCommonUtil.isNotUndefined(sku)){
                id = sku.id
                title = sku.title
                price = sku.price
                inventory = sku.inventory
            }
            var newEle = '<tr><td><input type="hidden" name="id" disabled value="'+id+'"><input class="form-control" type="text" name="skuTitle" style="width: 100%"  placeholder="字符数小于20" minlength="1" maxlength="20" required value="'+ title +'"/></td><td><input class="form-control" type="number" name="skuPrice" pattern="^(\\d+|\\d+\\.\\d{1,2})$" placeholder="整数或两位小数，不小于0", min="0" required value="'+ price +'"/></td><td><input class="form-control" type="number" name="skuInventory" pattern="^(\\d+)$" placeholder="整数，不小于0", min="0" required value="'+ inventory +'"/></td><td><button type="button" class="btn btn-primary btn-xs add-sku">+</button>&nbsp;<button type="button" class="btn btn-primary btn-xs reduce-sku">-</button></td></tr>'
            $('#itemEdit .sku-table tbody:first').append(newEle)
        }

        /*查询form*/
        bindFormCallback({
            pageId:'itemEdit',
            formId:'itemEditQForm',
            submitId:'query',
            formVerify:function (data) {
                log('itemEdit verify')
                return !ObjectCommonUtil.isEmpty(data.id)
            },
            submitResultDeal:function (data) {
                var d = data.d
                for (var key in d){
                    if (key == 'attr' || key == 'logistics') {
                        for (var key2 in d[key]){
                            var name = key.concat('.').concat(key2)
                            var val = d[key][key2]
                            FormUtil.fillVal('#itemEdit #itemEditForm', name, val)
                        }
                    }else if (key == 'skus'){
                        for (var key2 in d[key]){
                            var sku = d[key][key2]
                            addSkuInItemEdit(sku)
                        }
                    }else if(key == 'detail'){
                        if (StringUtil.isNotEmpty(d[key])) {
                            $('#itemEdit #itemEditForm #item-detail-container').parent().data('init', d[key])
                            if (StringUtil.isNotEmpty($('#itemEdit #itemEditForm #item-detail-container').html()) ){
                                //$('#itemEdit #itemEditForm #item-detail-container').html(d[key])
                                editor.setContent(d[key])
                            }
                        }
                    }else if (key == 'imgs'){
                        if (!ObjectCommonUtil.isEmpty(d[key]) ){
                            var imgs = d[key].split(',')
                            for (var index in imgs){
                                fileUploadUtils.appendImgs('#itemEdit #fileupload', imgs[index])
                            }
                        }
                    } else {
                        FormUtil.fillVal('#itemEdit #itemEditForm', key, d[key])
                    }
                }
            }
        })

        /*商品信息form*/
        bindFormCallback({
            pageId:'itemEdit',
            formId:'itemEditForm',
            submitId:'save',
            post: true,
            /*headers:{
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },*/
            formVerify:function (data) {
                var result = $('#itemEdit #itemEditForm').validator('isFormValid')
                return result
            },
            submitDataAppend:function(data){
                $('#itemEdit .panel-sku table tbody tr').each(function (index) {
                    var skuTitle = $(this).find('input[name="skuTitle"]').val()
                    var skuId = $(this).find('input[name="id"]').val()
                    var skuPrice = $(this).find('input[name="skuPrice"]').val()
                    var skuInventory = $(this).find('input[name="skuInventory"]').val()

                    data['skus['+index+'].id'] = skuId
                    data['skus['+index+'].title'] = skuTitle
                    data['skus['+index+'].price'] = skuPrice
                    data['skus['+index+'].inventory'] = skuInventory
                })

                var detail = editor.getContent()
                data.detail = detail
            },
            submitResultDeal:function (data) {
                // var d = data.d
                if (data.s){
                    castSuccessMsg("成功")
                    closeCurrentTabMenu()
                }
            }
        })

        CateUtils.load()

        var editor
        var initUeditor = function () {
            UE.delEditor('item-detail-container')
            editor = UE.getEditor('item-detail-container',{
                serverUrl: "/uditor/config",
                onready:function () {
                    if (!ObjectCommonUtil.isEmpty($('#itemEdit #itemEditForm #item-detail-container').parent().data('init'))){
                        this.setContent($('#itemEdit #itemEditForm #item-detail-container').parent().data('init'))
                    }
                    /*每个页面都应取一次数据，以便获取参数*/
                    jumpContextData.dealJumpContextData(function (data) {
                        if (!ObjectCommonUtil.isEmpty(data.itemId)) {
                            $('#itemEdit').find('#itemEditQForm input[name="id"]:first').val(data.itemId)
                            $("#itemEditQForm #query").click()
                        }
                    })
                    resizeContentHeight()
                },
                initialFrameWidth: 400,
                initialFrameHeight:450,
                autoHeightEnabled: false,
                enableAutoSave: false,
                enableContextMenu: false,
                maximumWords:512,
                toolbars: [
                    [
                        'source', //源代码
                        'undo', //撤销
                        'redo', //重做
                        'removeformat', //清除格式
                        'horizontal', //分隔线
                        'indent', //首行缩进
                        'justifyleft', //居左对齐
                        'justifyright', //居右对齐
                        'justifycenter', //居中对齐
                        'justifyjustify', //两端对齐
                        'bold', //加粗
                        'forecolor', //字体颜色
                        'fontfamily', //字体
                        'fontsize', //字号
                        'paragraph', //段落格式
                        //'simpleupload', //单图上传
                        'insertimage', //多图上传
                        'inserttitle', //插入标题
                        'insertorderedlist', //有序列表
                        'insertunorderedlist', //无序列表
                        'edittip ', //编辑提示
                        'autotypeset', //自动排版
                        'cleardoc', //清空文档
                    ]
                ]
            })
        }

        initUeditor()
    })

</script>
